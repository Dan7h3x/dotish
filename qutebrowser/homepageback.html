<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MyHome</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --warning-gradient: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        --danger-gradient: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
      }

      .theme-light {
        --bg-color: #f8fafc;
        --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --text-color: #2d3748;
        --card-bg: rgba(255, 255, 255, 0.95);
        --card-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        --border-color: #e2e8f0;
        --accent-color: #667eea;
        --hover-bg: #f7fafc;
        --input-bg: #ffffff;
      }

      .theme-dark {
        --bg-color: #1a202c;
        --bg-gradient: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
        --text-color: #f7fafc;
        --card-bg: rgba(45, 55, 72, 0.95);
        --card-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        --border-color: #4a5568;
        --accent-color: #9f7aea;
        --hover-bg: #2d3748;
        --input-bg: #2d3748;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: var(--bg-gradient);
        min-height: 100vh;
        color: var(--text-color);
        transition: all 0.3s ease;
        position: relative;
        overflow-x: hidden;
      }

      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--bg-gradient);
        z-index: -1;
        animation: gradientShift 15s ease infinite;
      }

      @keyframes gradientShift {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.8;
        }
      }

      .container {
        max-width: 1080px;
        margin: 0 auto;
        padding: 1rem;
        min-height: 100vh;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        backdrop-filter: blur(10px);
        background: var(--card-bg);
        padding: 1rem 2rem;
        border-radius: 20px;
        box-shadow: var(--card-shadow);
        border: 1px solid var(--border-color);
      }

      .theme-toggle button {
        background: var(--primary-gradient);
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        font-size: 1.5rem;
        cursor: pointer;
        transition: transform 0.4s ease-out;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      .theme-toggle button:hover {
        transform: scale(1.2) rotate(-45deg);
      }

      .search-bar {
        flex-grow: 1;
        margin: 0 4rem;
      }

      .search-bar input {
        width: 100%;
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 25px;
        font-size: 1rem;
        background: var(--input-bg);
        color: var(--text-color);
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .search-bar input:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
        transform: translateY(-2px);
      }

      .main-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
        align-items: start;
        transition: all 0.3s ease;
      }

      .main-grid.edit-mode {
        gap: 1.5rem;
      }

      .card {
        background: var(--card-bg);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 1.2rem;
        box-shadow: var(--card-shadow);
        border: 1px solid var(--border-color);
        transition:
          transform 0.3s ease,
          box-shadow 0.3s ease,
          border-color 0.3s ease;
        height: fit-content;
        min-height: 180px;
        display: flex;
        flex-direction: column;
        position: relative;
      }

      .card.draggable {
        cursor: move;
        user-select: none;
      }

      .card.dragging {
        opacity: 0.7;
        transform: rotate(5deg) scale(1.05);
        z-index: 1000;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      }

      .card.drag-over {
        border-color: var(--accent-color);
        transform: scale(1.02);
        box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
        background: rgba(102, 126, 234, 0.1);
      }

      .card.drag-active {
        transition: all 0.2s ease;
      }

      .card.drag-active:not(.dragging):not(.drag-over) {
        opacity: 0.7;
        transform: scale(0.95);
      }

      .edit-mode-toggle {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1001;
        background: var(--primary-gradient);
        border: none;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        font-size: 1.5rem;
        color: white;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
      }

      .edit-mode-toggle:hover {
        transform: scale(1.1);
      }

      .edit-mode-toggle.active {
        background: var(--warning-gradient);
        animation: pulse 2s infinite;
      }

      .card:hover {
        transform: translateY(-3px) scale(1.01);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
      }

      .card-title {
        font-size: 1.3rem;
        font-weight: 700;
        margin-bottom: 0.8rem;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-shrink: 0;
      }

      .card-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }

      .card-compact {
        min-height: 120px;
        padding: 1rem;
      }

      .card-medium {
        min-height: 200px;
      }

      .card-large {
        min-height: 280px;
      }

      .card-full-width {
        grid-column: 1 / -1;
        text-align: center;
        min-height: 140px;
      }

      /* Masonry-like layout for better space utilization */
      @supports (grid-template-rows: masonry) {
        .main-grid {
          grid-template-rows: masonry;
        }
      }

      .bookmarks-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
        min-height: 60px;
      }

      .bookmark-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 1rem;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.1) 0%,
          rgba(255, 255, 255, 0.05) 100%
        );
        min-height: 80px;
        position: relative;
      }

      .bookmark-item:hover {
        background: linear-gradient(
          135deg,
          rgba(102, 126, 234, 0.2) 0%,
          rgba(118, 75, 162, 0.2) 100%
        );
        transform: scale(1.05);
      }

      .bookmark-icon {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        margin-bottom: 0.5rem;
      }

      .bookmark-delete {
        position: absolute;
        top: 5px;
        right: 5px;
        background: var(--danger-gradient);
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 12px;
        color: white;
        cursor: pointer;
        display: none;
      }

      .bookmark-item:hover .bookmark-delete {
        display: block;
      }

      .todo-input {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
      }

      .todo-input input[type="text"] {
        flex: 1;
        min-width: 200px;
        padding: 0.8rem;
        border: none;
        border-radius: 10px;
        background: var(--input-bg);
        color: var(--text-color);
      }

      .todo-input input[type="date"] {
        padding: 0.8rem;
        border: none;
        border-radius: 10px;
        background: var(--input-bg);
        color: var(--text-color);
      }

      .btn {
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        background: var(--primary-gradient);
        color: white;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .btn-small {
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
      }

      .todo-list {
        list-style: none;
        max-height: 300px;
        overflow-y: auto;
      }

      .todo-item {
        display: flex;
        align-items: center;
        padding: 0.8rem;
        margin-bottom: 0.5rem;
        border-radius: 10px;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.1) 0%,
          rgba(255, 255, 255, 0.05) 100%
        );
        transition: all 0.3s ease;
        gap: 1rem;
      }

      .todo-item:hover {
        transform: translateX(5px);
      }

      .todo-item.completed {
        opacity: 0.6;
        text-decoration: line-through;
      }

      .todo-item.overdue {
        border-left: 4px solid #ff6b6b;
        background: linear-gradient(
          135deg,
          rgba(255, 107, 107, 0.1) 0%,
          rgba(255, 107, 107, 0.05) 100%
        );
      }

      .todo-item.due-soon {
        border-left: 4px solid #ffd93d;
        background: linear-gradient(
          135deg,
          rgba(255, 217, 61, 0.1) 0%,
          rgba(255, 217, 61, 0.05) 100%
        );
      }

      .todo-item.priority-high {
        border-left: 4px solid #ff6b6b;
        background: linear-gradient(
          135deg,
          rgba(255, 107, 107, 0.15) 0%,
          rgba(255, 107, 107, 0.08) 100%
        );
      }

      .todo-item.priority-medium {
        border-left: 4px solid #ffa726;
        background: linear-gradient(
          135deg,
          rgba(255, 167, 38, 0.15) 0%,
          rgba(255, 167, 38, 0.08) 100%
        );
      }

      .todo-item.priority-low {
        border-left: 4px solid #66bb6a;
        background: linear-gradient(
          135deg,
          rgba(102, 187, 106, 0.15) 0%,
          rgba(102, 187, 106, 0.08) 100%
        );
      }

      .priority-badge {
        padding: 0.2rem 0.5rem;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .priority-high .priority-badge {
        background: rgba(255, 107, 107, 0.2);
        color: #d32f2f;
      }

      .priority-medium .priority-badge {
        background: rgba(255, 167, 38, 0.2);
        color: #f57c00;
      }

      .priority-low .priority-badge {
        background: rgba(102, 187, 106, 0.2);
        color: #388e3c;
      }

      .todo-item span {
        flex: 1;
      }

      .calendar-container {
        text-align: center;
      }

      .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .calendar-nav {
        background: var(--primary-gradient);
        border: none;
        color: white;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        cursor: pointer;
        font-weight: bold;
        font-size: 16px;
      }

      .calendar-nav:hover {
        transform: scale(1.1);
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
        margin-top: 1rem;
        background: var(--border-color);
        border-radius: 10px;
        padding: 10px;
      }

      .calendar-day-header {
        padding: 8px 4px;
        font-weight: 600;
        font-size: 0.8rem;
        color: var(--accent-color);
        text-align: center;
      }

      .calendar-day {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        background: var(--card-bg);
        color: var(--text-color);
        font-size: 0.9rem;
      }

      .calendar-day:hover {
        background: var(--hover-bg);
        transform: scale(1.1);
      }

      .calendar-day.today {
        background: var(--primary-gradient);
        color: white;
        font-weight: bold;
      }

      .calendar-day.has-todos {
        background: var(--danger-gradient);
        color: white;
      }

      .calendar-day.other-month {
        opacity: 0.3;
      }

      .notes-container {
        height: 300px;
        display: flex;
        flex-direction: column;
      }

      .notes-input input {
        width: 100%;
        padding: 0.8rem;
        border: none;
        border-radius: 10px;
        background: var(--input-bg);
        color: var(--text-color);
        margin-bottom: 1rem;
      }

      .notes-list {
        flex: 1;
        overflow-y: auto;
      }

      .note-item {
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.1) 0%,
          rgba(255, 255, 255, 0.05) 100%
        );
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .note-item:hover {
        transform: translateX(5px);
        background: linear-gradient(
          135deg,
          rgba(102, 126, 234, 0.1) 0%,
          rgba(118, 75, 162, 0.1) 100%
        );
      }

      .note-text {
        margin-bottom: 0.5rem;
        word-wrap: break-word;
      }

      .note-date {
        font-size: 0.8rem;
        opacity: 0.7;
      }

      .clock {
        font-size: 3rem;
        font-weight: 300;
        margin-bottom: 0.5rem;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .date {
        font-size: 1.2rem;
        opacity: 0.8;
      }

      .floating-particles {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: -1;
        overflow: hidden;
      }

      .particle {
        position: absolute;
        width: 3px;
        height: 3px;
        background: rgba(255, 255, 255, 0.4);
        border-radius: 50%;
        transition: all 0.1s ease-out;
        animation: float 8s infinite linear;
      }

      .particle.mouse-nearby {
        background: rgba(102, 126, 234, 0.8);
        width: 6px;
        height: 6px;
        box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
      }

      .interactive-particle {
        position: absolute;
        width: 2px;
        height: 2px;
        background: rgba(102, 126, 234, 0.6);
        border-radius: 50%;
        pointer-events: none;
        transition: all 0.3s ease-out;
      }

      .star-trail {
        position: absolute;
        pointer-events: none;
        z-index: 1;
      }

      .star {
        position: absolute;
        width: 4px;
        height: 4px;
        background: radial-gradient(circle, #ffffff 0%, #667eea 70%, transparent 100%);
        border-radius: 50%;
        animation: starTwinkle 1.5s ease-out forwards;
        box-shadow: 0 0 6px rgba(102, 126, 234, 0.8);
      }

      .star::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 12px;
        height: 1px;
        background: linear-gradient(90deg, transparent, #ffffff, transparent);
        transform: translate(-50%, -50%);
        animation: starBeam 1.5s ease-out forwards;
      }

      .star::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 1px;
        height: 12px;
        background: linear-gradient(180deg, transparent, #ffffff, transparent);
        transform: translate(-50%, -50%);
        animation: starBeam 1.5s ease-out forwards;
      }

      @keyframes float {
        0% {
          transform: translateY(100vh) rotate(0deg);
          opacity: 0;
        }
        10% {
          opacity: 1;
        }
        90% {
          opacity: 1;
        }
        100% {
          transform: translateY(-100vh) rotate(360deg);
          opacity: 0;
        }
      }

      @keyframes pulse {
        0%, 100% {
          transform: scale(1);
          opacity: 0.6;
        }
        50% {
          transform: scale(1.5);
          opacity: 1;
        }
      }

      @keyframes starTwinkle {
        0% {
          opacity: 1;
          transform: scale(0.8);
        }
        30% {
          opacity: 1;
          transform: scale(1.2);
        }
        100% {
          opacity: 0;
          transform: scale(0.3);
        }
      }

      @keyframes starBeam {
        0% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(0.5);
        }
        50% {
          opacity: 0.8;
          transform: translate(-50%, -50%) scale(1);
        }
        100% {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.8);
        }
      }

      @media (max-width: 768px) {
        .main-grid {
          grid-template-columns: 1fr;
          gap: 1rem;
        }

        .card {
          min-height: 150px;
          padding: 1rem;
        }

        .card-title {
          font-size: 1.2rem;
        }

        header {
          flex-direction: column;
          gap: 1rem;
          padding: 1rem;
        }

        .search-bar {
          margin: 0;
          width: 100%;
        }

        .todo-input {
          flex-direction: column;
        }

        .todo-input input[type="text"] {
          min-width: auto;
        }

        .clock {
          font-size: 2rem;
        }

        .calendar-grid {
          font-size: 0.8rem;
        }

        .container {
          padding: 0.5rem;
        }
      }

      @media (max-width: 480px) {
        .main-grid {
          grid-template-columns: 1fr;
          gap: 0.8rem;
        }
        
        .card {
          padding: 0.8rem;
          border-radius: 15px;
        }
        
        .clock {
          font-size: 1.8rem;
        }
      }
    </style>
  </head>
  <body class="theme-light">
    <div class="floating-particles" id="particles"></div>
    <button class="edit-mode-toggle" id="editModeToggle" title="Toggle Edit Mode">‚úèÔ∏è</button>

    <div class="container">
      <header>
        <div class="theme-toggle">
          <button id="themeToggle">üåô</button>
        </div>
        <div class="search-bar">
          <input type="text" id="searchInput" placeholder="Search the web..." />
        </div>
      </header>

      <div class="main-grid">
        <div class="card card-compact">
          <h2 class="card-title">üìö Bookmarks</h2>
          <div class="card-content">
            <div id="bookmarksList" class="bookmarks-grid" style="flex: 1; min-height: 60px;"></div>
            <button id="addBookmark" class="btn" style="margin-top: 0.5rem;">+ Add Bookmark</button>
          </div>
        </div>

        <div class="card card-medium">
          <h2 class="card-title">‚úÖ Todo List</h2>
          <div class="card-content">
            <div class="todo-input">
              <input type="text" id="todoInput" placeholder="Add a new task..." style="flex: 1; min-width: 150px;" />
              <select id="todoPriority" style="padding: 0.8rem; border: none; border-radius: 10px; background: var(--input-bg); color: var(--text-color); min-width: 80px;">
                <option value="low">Low</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High</option>
              </select>
              <input type="date" id="todoDate" style="min-width: 120px;" />
              <button id="addTodo" class="btn">Add</button>
            </div>
            <ul id="todoList" class="todo-list" style="flex: 1; overflow-y: auto;"></ul>
          </div>
        </div>

        <div class="card card-medium">
          <h2 class="card-title">üìÖ Calendar</h2>
          <div class="card-content">
            <div class="calendar-container">
              <div class="calendar-header">
                <button class="calendar-nav" id="prevMonth">‚Äπ</button>
                <h3 id="currentMonth">November 2024</h3>
                <button class="calendar-nav" id="nextMonth">‚Ä∫</button>
              </div>
              <div class="calendar-grid" id="calendarGrid"></div>
              <div id="calendarEvents" style="margin-top: 1rem; font-size: 0.9rem; max-height: 80px; overflow-y: auto;">
                <div style="font-weight: 600; margin-bottom: 0.5rem;">Today's Events:</div>
                <div id="todayEvents">No events today</div>
              </div>
            </div>
          </div>
        </div>

        <div class="card card-medium">
          <h2 class="card-title">üìù Sticky Notes</h2>
          <div class="card-content">
            <div class="notes-container" style="height: 100%; display: flex; flex-direction: column;">
              <div class="notes-input">
                <input
                  type="text"
                  id="noteInput"
                  placeholder="Add a quick note..."
                />
              </div>
              <div class="notes-list" id="notesList" style="flex: 1; overflow-y: auto;"></div>
            </div>
          </div>
        </div>

        <div class="card card-compact">
          <h2 class="card-title">üå§Ô∏è Weather</h2>
          <div class="card-content">
            <div id="weatherWidget" style="text-align: center;">
              <div id="weatherLocation" style="font-size: 0.9rem; margin-bottom: 0.5rem;">üìç Getting location...</div>
              <div id="weatherTemp" style="font-size: 1.8rem; margin: 0.5rem 0; font-weight: 300;">--¬∞</div>
              <div id="weatherDesc" style="font-size: 0.9rem; margin-bottom: 0.5rem;">Loading weather...</div>
              <div id="weatherDetails" style="font-size: 0.8rem; opacity: 0.8;"></div>
            </div>
          </div>
        </div>



        <div class="card card-compact">
          <h2 class="card-title">‚è∞ Pomodoro Timer</h2>
          <div class="card-content" style="text-align: center;">
            <div id="pomodoroDisplay" style="font-size: 1.8rem; margin: 0.5rem 0; font-weight: 300;">25:00</div>
            <div style="display: flex; gap: 0.4rem; justify-content: center; margin-bottom: 0.8rem;">
              <button onclick="homepage.pomodoro.start()" class="btn btn-small">‚ñ∂Ô∏è</button>
              <button onclick="homepage.pomodoro.pause()" class="btn btn-small">‚è∏Ô∏è</button>
              <button onclick="homepage.pomodoro.reset()" class="btn btn-small">üîÑ</button>
            </div>
            <div id="pomodoroStatus" style="font-size: 0.85rem; opacity: 0.8;">Ready to focus</div>
          </div>
        </div>

        <div class="card card-compact">
          <h2 class="card-title">üé® Theme Customizer</h2>
          <div class="card-content" style="display: flex; flex-direction: column; gap: 0.6rem;">
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.4rem;">
              <button onclick="homepage.customTheme.setPreset('default')" class="btn btn-small" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">Default</button>
              <button onclick="homepage.customTheme.setPreset('tokyonight')" class="btn btn-small" style="background: linear-gradient(135deg, #7aa2f7 0%, #bb9af7 100%);">Tokyo Night</button>
              <button onclick="homepage.customTheme.setPreset('rosepine')" class="btn btn-small" style="background: linear-gradient(135deg, #eb6f92 0%, #f6c177 100%);">Rose Pine</button>
              <button onclick="homepage.customTheme.setPreset('catppuccin')" class="btn btn-small" style="background: linear-gradient(135deg, #cba6f7 0%, #89b4fa 100%);">Catppuccin</button>
              <button onclick="homepage.customTheme.setPreset('dracula')" class="btn btn-small" style="background: linear-gradient(135deg, #bd93f9 0%, #ff79c6 100%);">Dracula</button>
              <button onclick="homepage.customTheme.setPreset('nord')" class="btn btn-small" style="background: linear-gradient(135deg, #88c0d0 0%, #81a1c1 100%);">Nord</button>
            </div>
            <button onclick="homepage.customTheme.randomize()" class="btn btn-small">üé≤ Random Theme</button>
          </div>
        </div>

        <div class="card card-full-width">
          <div id="clock" class="clock"></div>
          <div id="date" class="date"></div>
          <div style="margin-top: 1rem; font-size: 0.8rem; opacity: 0.7">
            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.5rem;">
              <button
                onclick="homepage.testSave()"
                class="btn btn-small"
              >
                Test Storage
              </button>
              <button
                onclick="homepage.exportData()"
                class="btn btn-small"
                style="background: var(--success-gradient)"
              >
                Export Data
              </button>
              <button
                onclick="homepage.importData()"
                class="btn btn-small"
                style="background: var(--warning-gradient)"
              >
                Import Data
              </button>
              <button
                onclick="homepage.clearAll()"
                class="btn btn-small"
                style="background: var(--danger-gradient)"
              >
                Clear All Data
              </button>
            </div>
            <div id="debugInfo" style="margin-top: 0.5rem"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      class EnhancedHomepage {
        constructor() {
          this.todos = [];
          this.bookmarks = [];
          this.notes = [];
          this.isDark = false;
          this.currentDate = new Date();
          this.particles = [];
          this.mouseX = 0;
          this.mouseY = 0;
          this.interactiveParticles = [];
          this.isEditMode = false;
          this.cardOrder = [];

          // Initialize new features
          this.pomodoro = new PomodoroTimer();
          this.customTheme = new ThemeCustomizer();
          this.weather = new WeatherWidget();
          this.storage = new SafeStorage();

          // Wait for DOM to load
          if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", () => this.init());
          } else {
            this.init();
          }
        }

        init() {
          this.loadFromLocalStorage();
          this.setupEventListeners();
          this.updateClock();
          this.renderCalendar();
          this.render();
          this.createParticles();

          // Initialize new features
          this.pomodoro.updateDisplay();
          this.weather.init();
          
          // Apply saved card order if exists
          this.applyCardOrder();
          
          // Setup drag and drop after card order is applied
          setTimeout(() => {
            this.setupDragAndDrop();
            console.log('Homepage initialized with drag and drop support');
          }, 100);

          // Request notification permission for Pomodoro
          if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
          }

          // Show welcome message for new users
          this.showWelcomeMessage();

          // Initialize with some sample data if everything is empty
          if (
            this.bookmarks.length === 0 &&
            this.todos.length === 0 &&
            this.notes.length === 0
          ) {
            this.addSampleData();
          }

          // Debug localStorage
          console.log("Loaded data:", {
            todos: this.todos.length,
            bookmarks: this.bookmarks.length,
            notes: this.notes.length,
            theme: this.isDark ? "dark" : "light",
          });
        }

        addSampleData() {
          this.bookmarks = [
            {
              id: "1",
              title: "Google",
              url: "https://google.com",
              icon: "https://www.google.com/s2/favicons?domain=google.com",
            },
            {
              id: "2",
              title: "GitHub",
              url: "https://github.com",
              icon: "https://www.google.com/s2/favicons?domain=github.com",
            },
          ];

          this.todos = [
            {
              id: "3",
              text: "Welcome to your new homepage!",
              completed: false,
              dueDate: new Date().toISOString().split("T")[0],
              createdAt: new Date().toISOString(),
            },
          ];

          this.notes = [
            {
              id: "4",
              text: "Welcome! This is your first sticky note. Double-click to delete.",
              createdAt: new Date().toISOString(),
            },
          ];

          this.saveToLocalStorage();
          this.render();
          this.renderCalendar();
        }

        loadFromLocalStorage() {
          try {
            console.log("Loading from localStorage...");

            const savedTodos = this.storage.getItem("homepage_todos");
            const savedBookmarks = this.storage.getItem("homepage_bookmarks");
            const savedNotes = this.storage.getItem("homepage_notes");
            const savedTheme = this.storage.getItem("homepage_theme");
            const savedCardOrder = this.storage.getItem("cardOrder");

            console.log("Raw localStorage data:", {
              todos: savedTodos,
              bookmarks: savedBookmarks,
              notes: savedNotes,
              theme: savedTheme,
              cardOrder: savedCardOrder,
            });

            if (savedTodos && savedTodos !== "null") {
              this.todos = JSON.parse(savedTodos);
              console.log("Loaded todos:", this.todos);
            }
            if (savedBookmarks && savedBookmarks !== "null") {
              this.bookmarks = JSON.parse(savedBookmarks);
              console.log("Loaded bookmarks:", this.bookmarks);
            }
            if (savedNotes && savedNotes !== "null") {
              this.notes = JSON.parse(savedNotes);
              console.log("Loaded notes:", this.notes);
            }
            if (savedCardOrder && savedCardOrder !== "null") {
              this.cardOrder = JSON.parse(savedCardOrder);
              console.log("Loaded card order:", this.cardOrder);
            }
            if (savedTheme === "dark") {
              this.isDark = true;
              document.body.className = "theme-dark";
              const themeToggle = document.getElementById("themeToggle");
              if (themeToggle) themeToggle.textContent = "‚òÄÔ∏è";
            }
          } catch (e) {
            console.error("Error loading from localStorage:", e);
            // Reset arrays if corrupted
            this.todos = [];
            this.bookmarks = [];
            this.notes = [];
            this.cardOrder = [];
          }
        }

        saveToLocalStorage() {
          try {
            console.log("Saving to localStorage...", {
              todos: this.todos.length,
              bookmarks: this.bookmarks.length,
              notes: this.notes.length,
              theme: this.isDark ? "dark" : "light",
              cardOrder: this.cardOrder.length,
            });

            this.storage.setItem("homepage_todos", JSON.stringify(this.todos));
            this.storage.setItem("homepage_bookmarks", JSON.stringify(this.bookmarks));
            this.storage.setItem("homepage_notes", JSON.stringify(this.notes));
            this.storage.setItem("homepage_theme", this.isDark ? "dark" : "light");
            this.storage.setItem("cardOrder", JSON.stringify(this.cardOrder));

            console.log("Data saved successfully");
          } catch (e) {
            console.error("Error saving to localStorage:", e);
            this.storage.showStorageError();
          }
        }

        setupEventListeners() {
          // Theme toggle
          const themeToggle = document.getElementById("themeToggle");
          if (themeToggle) {
            themeToggle.addEventListener("click", () => this.toggleTheme());
          }

          // Search
          const searchInput = document.getElementById("searchInput");
          if (searchInput) {
            searchInput.addEventListener("keypress", (e) => {
              if (e.key === "Enter" && e.target.value.trim()) {
                window.open(
                  `https://www.google.com/search?q=${encodeURIComponent(e.target.value)}`,
                  "_blank",
                );
                e.target.value = "";
              }
            });
          }

          // Todo
          const addTodoBtn = document.getElementById("addTodo");
          const todoInput = document.getElementById("todoInput");

          if (addTodoBtn) {
            addTodoBtn.addEventListener("click", () => {
              const text = document.getElementById("todoInput").value;
              const date = document.getElementById("todoDate").value;
              const priority = document.getElementById("todoPriority").value;
              this.addTodo(text, date, priority);
            });
          }

          if (todoInput) {
            todoInput.addEventListener("keypress", (e) => {
              if (e.key === "Enter") {
                const text = e.target.value;
                const date = document.getElementById("todoDate").value;
                const priority = document.getElementById("todoPriority").value;
                this.addTodo(text, date, priority);
              }
            });
          }

          // Bookmarks
          const addBookmarkBtn = document.getElementById("addBookmark");
          if (addBookmarkBtn) {
            addBookmarkBtn.addEventListener("click", () => this.addBookmark());
          }

          // Notes
          const noteInput = document.getElementById("noteInput");
          if (noteInput) {
            noteInput.addEventListener("keypress", (e) => {
              if (e.key === "Enter" && e.target.value.trim()) {
                this.addNote(e.target.value);
              }
            });
          }

          // Calendar navigation
          const prevMonth = document.getElementById("prevMonth");
          const nextMonth = document.getElementById("nextMonth");

          if (prevMonth) {
            prevMonth.addEventListener("click", () => {
              this.currentDate.setMonth(this.currentDate.getMonth() - 1);
              this.renderCalendar();
            });
          }

          if (nextMonth) {
            nextMonth.addEventListener("click", () => {
              this.currentDate.setMonth(this.currentDate.getMonth() + 1);
              this.renderCalendar();
            });
          }

          // Edit mode toggle
          const editModeToggle = document.getElementById('editModeToggle');
          if (editModeToggle) {
            editModeToggle.addEventListener('click', () => this.toggleEditMode());
          }
        }

        setupDragAndDrop() {
          // Remove existing event listeners
          this.cleanupDragListeners();
          
          const cards = document.querySelectorAll('.card');
          const mainGrid = document.querySelector('.main-grid');
          
          if (!mainGrid) return;

          // Store references for cleanup
          this.dragEventListeners = [];
          
          cards.forEach((card, index) => {
            // Reset card state
            card.classList.remove('draggable', 'dragging', 'drag-over');
            card.removeAttribute('draggable');
            
            if (this.isEditMode) {
              card.draggable = true;
              card.classList.add('draggable');
              card.dataset.cardIndex = index;

              // Create bound event handlers
              const dragStart = (e) => {
                if (!this.isEditMode) {
                  e.preventDefault();
                  return false;
                }
                
                this.draggedCard = card;
                this.draggedIndex = index;
                card.classList.add('dragging');
                
                // Set drag data
                e.dataTransfer.setData('text/plain', index.toString());
                e.dataTransfer.effectAllowed = 'move';
                
                // Add visual feedback to all cards
                cards.forEach(c => c.classList.add('drag-active'));
                
                console.log('Drag started:', index);
              };

              const dragEnd = (e) => {
                card.classList.remove('dragging');
                cards.forEach(c => c.classList.remove('drag-active', 'drag-over'));
                this.draggedCard = null;
                this.draggedIndex = null;
                console.log('Drag ended');
              };

              const dragOver = (e) => {
                if (!this.isEditMode || !this.draggedCard) return;
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                // Only highlight if it's a different card
                if (card !== this.draggedCard) {
                  card.classList.add('drag-over');
                }
              };

              const dragLeave = (e) => {
                // Only remove highlight if we're really leaving the card
                const rect = card.getBoundingClientRect();
                const x = e.clientX;
                const y = e.clientY;
                
                if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
                  card.classList.remove('drag-over');
                }
              };

              const drop = (e) => {
                if (!this.isEditMode || !this.draggedCard) return;
                e.preventDefault();
                card.classList.remove('drag-over');
                
                const targetIndex = index;
                const sourceIndex = this.draggedIndex;
                
                console.log(`Drop: moving from ${sourceIndex} to ${targetIndex}`);
                
                if (sourceIndex !== null && sourceIndex !== targetIndex) {
                  this.reorderCards(sourceIndex, targetIndex);
                }
              };

              // Add event listeners
              card.addEventListener('dragstart', dragStart);
              card.addEventListener('dragend', dragEnd);
              card.addEventListener('dragover', dragOver);
              card.addEventListener('dragleave', dragLeave);
              card.addEventListener('drop', drop);

              // Store for cleanup
              this.dragEventListeners.push({
                element: card,
                events: [
                  { type: 'dragstart', handler: dragStart },
                  { type: 'dragend', handler: dragEnd },
                  { type: 'dragover', handler: dragOver },
                  { type: 'dragleave', handler: dragLeave },
                  { type: 'drop', handler: drop }
                ]
              });
            }
          });

          // Add grid-level drag over for better drop zones
          if (this.isEditMode) {
            const gridDragOver = (e) => {
              e.preventDefault();
            };
            
            mainGrid.addEventListener('dragover', gridDragOver);
            this.dragEventListeners.push({
              element: mainGrid,
              events: [{ type: 'dragover', handler: gridDragOver }]
            });
          }
        }

        cleanupDragListeners() {
          if (this.dragEventListeners) {
            this.dragEventListeners.forEach(({ element, events }) => {
              events.forEach(({ type, handler }) => {
                element.removeEventListener(type, handler);
              });
            });
            this.dragEventListeners = [];
          }
        }

        toggleEditMode() {
          this.isEditMode = !this.isEditMode;
          const editToggle = document.getElementById('editModeToggle');
          const mainGrid = document.querySelector('.main-grid');
          
          if (this.isEditMode) {
            editToggle.classList.add('active');
            editToggle.textContent = 'üíæ';
            editToggle.title = 'Save Layout';
            mainGrid.classList.add('edit-mode');
          } else {
            editToggle.classList.remove('active');
            editToggle.textContent = '‚úèÔ∏è';
            editToggle.title = 'Toggle Edit Mode';
            mainGrid.classList.remove('edit-mode');
            this.storage.setItem('cardOrder', JSON.stringify(this.cardOrder));
          }
          
          this.setupDragAndDrop();
        }

        reorderCards(fromIndex, toIndex) {
          const mainGrid = document.querySelector('.main-grid');
          if (!mainGrid) return;
          
          const cards = Array.from(mainGrid.children);
          console.log(`Reordering: ${fromIndex} ‚Üí ${toIndex}, total cards: ${cards.length}`);
          
          if (fromIndex >= cards.length || toIndex >= cards.length || fromIndex < 0 || toIndex < 0) {
            console.error('Invalid card indices:', fromIndex, toIndex);
            return;
          }
          
          const draggedCard = cards[fromIndex];
          if (!draggedCard) {
            console.error('Dragged card not found at index:', fromIndex);
            return;
          }
          
          // Remove the card from its current position
          draggedCard.remove();
          
          // Insert at new position
          if (toIndex >= cards.length - 1) {
            // Insert at the end
            mainGrid.appendChild(draggedCard);
          } else {
            // Insert before the target position
            const targetCard = cards[toIndex];
            if (fromIndex < toIndex) {
              // Moving forward, insert after target
              mainGrid.insertBefore(draggedCard, targetCard.nextSibling);
            } else {
              // Moving backward, insert before target
              mainGrid.insertBefore(draggedCard, targetCard);
            }
          }
          
          // Update card order for persistence
          this.updateCardOrder();
          
          // Save the new order immediately
          this.saveToLocalStorage();
          
          // Re-setup drag and drop with new indices
          setTimeout(() => {
            this.setupDragAndDrop();
            console.log('Drag and drop re-initialized after reorder');
          }, 150);
        }

        updateCardOrder() {
          const cards = Array.from(document.querySelectorAll('.card'));
          this.cardOrder = cards.map(card => {
            // Get a unique identifier for each card type
            const title = card.querySelector('.card-title');
            return title ? title.textContent.trim() : 'unknown';
          });
          console.log('Updated card order:', this.cardOrder);
        }

        applyCardOrder() {
          if (!this.cardOrder || this.cardOrder.length === 0) {
            console.log('No saved card order to apply');
            return;
          }

          const mainGrid = document.querySelector('.main-grid');
          if (!mainGrid) return;

          const cards = Array.from(mainGrid.children);
          const orderedCards = [];

          // Try to arrange cards according to saved order
          this.cardOrder.forEach(cardTitle => {
            const card = cards.find(c => {
              const title = c.querySelector('.card-title');
              return title && title.textContent.trim() === cardTitle;
            });
            if (card) {
              orderedCards.push(card);
            }
          });

          // Add any remaining cards that weren't in the saved order
          cards.forEach(card => {
            if (!orderedCards.includes(card)) {
              orderedCards.push(card);
            }
          });

          // Reorder the DOM
          orderedCards.forEach(card => {
            mainGrid.appendChild(card);
          });

          console.log('Applied saved card order');
        }

        showWelcomeMessage() {
          const isFirstVisit = !this.storage.getItem('homepage_visited');
          
          if (isFirstVisit) {
            this.storage.setItem('homepage_visited', 'true');
            
            setTimeout(() => {
              const storageInfo = this.storage.getStorageInfo();
              const message = `üéâ Welcome to your Enhanced Homepage!

‚ú® Features available:
‚Ä¢ Drag & Drop: Click the edit button (‚úèÔ∏è) to reorganize cards
‚Ä¢ Todo Priorities: Add tasks with High/Medium/Low priority
‚Ä¢ Multiple Themes: Try Tokyo Night, Rose Pine, and more!
‚Ä¢ Export/Import: Backup your data anytime

üìù Storage Status: ${storageInfo.type} (${storageInfo.persistent ? 'persistent' : 'temporary'})

${storageInfo.type === 'memory' ? '‚ö†Ô∏è Note: Data will be lost when you close this tab. Consider exporting your data!' : ''}

Ready to start? Try adding a todo or bookmark!`;

              alert(message);
            }, 1000);
          }
        }

        toggleTheme() {
          this.isDark = !this.isDark;
          document.body.className = this.isDark ? "theme-dark" : "theme-light";
          const themeToggle = document.getElementById("themeToggle");
          if (themeToggle) {
            themeToggle.textContent = this.isDark ? "‚òÄÔ∏è" : "üåô";
          }
          console.log("Theme toggled to:", this.isDark ? "dark" : "light");
          this.saveToLocalStorage();
        }

        addTodo(text, dueDate, priority) {
          text = text.trim();
          if (!text) return;

          const todo = {
            id: Date.now().toString(),
            text,
            completed: false,
            dueDate: dueDate || null,
            priority: priority || 'medium',
            createdAt: new Date().toISOString(),
          };

          this.todos.push(todo);
          console.log("Added todo:", todo);
          this.saveToLocalStorage();
          this.render();
          this.renderCalendar();

          // Clear inputs
          const todoInput = document.getElementById("todoInput");
          const todoDate = document.getElementById("todoDate");
          const todoPriority = document.getElementById("todoPriority");
          if (todoInput) todoInput.value = "";
          if (todoDate) todoDate.value = "";
          if (todoPriority) todoPriority.value = "medium";
        }

        toggleTodo(id) {
          const todo = this.todos.find((t) => t.id === id);
          if (todo) {
            todo.completed = !todo.completed;
            this.saveToLocalStorage();
            this.render();
            this.renderCalendar();
          }
        }

        deleteTodo(id) {
          this.todos = this.todos.filter((t) => t.id !== id);
          this.saveToLocalStorage();
          this.render();
          this.renderCalendar();
        }

        addBookmark() {
          const title = prompt("Enter bookmark title:");
          if (!title) return;

          const url = prompt("Enter bookmark URL:");
          if (!url) return;

          const bookmark = {
            id: Date.now().toString(),
            title,
            url: url.startsWith("http") ? url : `https://${url}`,
            icon: `https://www.google.com/s2/favicons?domain=${url}`,
          };

          this.bookmarks.push(bookmark);
          console.log("Added bookmark:", bookmark);
          this.saveToLocalStorage();
          this.render();
        }

        deleteBookmark(id) {
          this.bookmarks = this.bookmarks.filter((b) => b.id !== id);
          this.saveToLocalStorage();
          this.render();
        }

        addNote(text) {
          const note = {
            id: Date.now().toString(),
            text: text.trim(),
            createdAt: new Date().toISOString(),
          };

          this.notes.unshift(note);
          console.log("Added note:", note);
          this.saveToLocalStorage();
          this.render();

          const noteInput = document.getElementById("noteInput");
          if (noteInput) noteInput.value = "";
        }

        deleteNote(id) {
          this.notes = this.notes.filter((n) => n.id !== id);
          this.saveToLocalStorage();
          this.render();
        }

        updateClock() {
          const updateTime = () => {
            const now = new Date();
            const clockEl = document.getElementById("clock");
            const dateEl = document.getElementById("date");

            if (clockEl) {
              clockEl.textContent = now.toLocaleTimeString();
            }
            if (dateEl) {
              dateEl.textContent = now.toLocaleDateString(undefined, {
                weekday: "long",
                year: "numeric",
                month: "long",
                day: "numeric",
              });
            }
          };

          updateTime();
          setInterval(updateTime, 1000);
        }

        renderCalendar() {
          const year = this.currentDate.getFullYear();
          const month = this.currentDate.getMonth();

          const currentMonthEl = document.getElementById("currentMonth");
          if (currentMonthEl) {
            currentMonthEl.textContent = new Date(
              year,
              month,
            ).toLocaleDateString(undefined, {
              month: "long",
              year: "numeric",
            });
          }

          const firstDay = new Date(year, month, 1);
          const startDate = new Date(firstDay);
          startDate.setDate(startDate.getDate() - firstDay.getDay());

          const calendarGrid = document.getElementById("calendarGrid");
          if (!calendarGrid) return;

          calendarGrid.innerHTML = "";

          // Day headers
          const dayHeaders = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
          dayHeaders.forEach((day) => {
            const dayHeader = document.createElement("div");
            dayHeader.className = "calendar-day-header";
            dayHeader.textContent = day;
            calendarGrid.appendChild(dayHeader);
          });

          // Calendar days
          for (let i = 0; i < 42; i++) {
            const date = new Date(startDate);
            date.setDate(startDate.getDate() + i);

            const dayElement = document.createElement("div");
            dayElement.className = "calendar-day";
            dayElement.textContent = date.getDate();

            // Check if day is in current month
            if (date.getMonth() !== month) {
              dayElement.classList.add("other-month");
            }

            // Check if today
            const today = new Date();
            if (date.toDateString() === today.toDateString()) {
              dayElement.classList.add("today");
            }

            // Check for todos on this date
            const dateString = date.toISOString().split("T")[0];
            const todosOnThisDate = this.todos.filter(
              (todo) => todo.dueDate === dateString && !todo.completed,
            );

            if (todosOnThisDate.length > 0) {
              dayElement.classList.add("has-todos");
              dayElement.title = `${todosOnThisDate.length} todo(s) due`;
            }

            calendarGrid.appendChild(dayElement);
          }

          // Update today's events
          this.updateTodayEvents();
        }

        updateTodayEvents() {
          const todayEventsEl = document.getElementById('todayEvents');
          if (!todayEventsEl) return;

          const today = new Date().toISOString().split('T')[0];
          const todayTodos = this.todos.filter(todo => 
            todo.dueDate === today && !todo.completed
          );

          if (todayTodos.length === 0) {
            todayEventsEl.innerHTML = '<div style="opacity: 0.6;">No events today</div>';
          } else {
            todayEventsEl.innerHTML = todayTodos
              .sort((a, b) => {
                const priorityOrder = { high: 3, medium: 2, low: 1 };
                return (priorityOrder[b.priority] || 2) - (priorityOrder[a.priority] || 2);
              })
              .map(todo => `
                <div style="margin-bottom: 0.3rem; padding: 0.3rem; border-radius: 6px; background: rgba(102, 126, 234, 0.1);">
                  <span style="font-size: 0.8rem;">${todo.text}</span>
                  <span class="priority-badge" style="font-size: 0.6rem; margin-left: 0.5rem;">${todo.priority}</span>
                </div>
              `).join('');
          }
        }

        getTodoStatus(todo) {
          if (!todo.dueDate) return "";

          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const dueDate = new Date(todo.dueDate);
          dueDate.setHours(0, 0, 0, 0);

          const diffTime = dueDate - today;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

          if (diffDays < 0) return "overdue";
          if (diffDays <= 3) return "due-soon";
          return "";
        }

        createParticles() {
          const particlesContainer = document.getElementById("particles");
          if (!particlesContainer) return;

          // Setup mouse tracking
          document.addEventListener('mousemove', (e) => {
            this.mouseX = e.clientX;
            this.mouseY = e.clientY;
            this.updateParticleInteractions();
            this.createMouseTrail(e.clientX, e.clientY);
          });

          // Create floating particles
          for (let i = 0; i < 40; i++) {
            const particle = document.createElement("div");
            particle.className = "particle";
            particle.style.left = Math.random() * 100 + "%";
            particle.style.animationDelay = Math.random() * 8 + "s";
            particle.style.animationDuration = Math.random() * 4 + 4 + "s";
            
            // Store particle data for interaction
            const particleData = {
              element: particle,
              originalX: Math.random() * window.innerWidth,
              originalY: Math.random() * window.innerHeight,
              x: Math.random() * window.innerWidth,
              y: Math.random() * window.innerHeight,
              vx: (Math.random() - 0.5) * 2,
              vy: (Math.random() - 0.5) * 2
            };
            
            this.particles.push(particleData);
            particlesContainer.appendChild(particle);
          }

          // Start particle animation loop
          this.animateParticles();
        }

        updateParticleInteractions() {
          this.particles.forEach(particle => {
            const distance = Math.sqrt(
              Math.pow(particle.x - this.mouseX, 2) + 
              Math.pow(particle.y - this.mouseY, 2)
            );
            
            if (distance < 100) {
              particle.element.classList.add('mouse-nearby');
              
              // Move particle away from mouse
              const angle = Math.atan2(particle.y - this.mouseY, particle.x - this.mouseX);
              const force = (100 - distance) / 100;
              particle.vx += Math.cos(angle) * force * 0.5;
              particle.vy += Math.sin(angle) * force * 0.5;
            } else {
              particle.element.classList.remove('mouse-nearby');
            }
          });
        }

        createMouseTrail(x, y) {
          // Create star trail effect
          if (Math.random() < 0.3) { // Only create stars occasionally for performance
            const star = document.createElement('div');
            star.className = 'star';
            star.style.left = (x - 2) + 'px';
            star.style.top = (y - 2) + 'px';
            
            // Add random sparkle effect
            const colors = ['#ffffff', '#667eea', '#764ba2', '#4facfe', '#ff9a9e'];
            const randomColor = colors[Math.floor(Math.random() * colors.length)];
            star.style.background = `radial-gradient(circle, ${randomColor} 0%, #667eea 70%, transparent 100%)`;
            star.style.boxShadow = `0 0 ${Math.random() * 10 + 4}px ${randomColor}`;
            
            document.getElementById('particles').appendChild(star);
            
            setTimeout(() => {
              if (star.parentNode) {
                star.parentNode.removeChild(star);
              }
            }, 1500);
          }
        }

        animateParticles() {
          this.particles.forEach(particle => {
            // Update position
            particle.x += particle.vx;
            particle.y += particle.vy;
            
            // Apply friction
            particle.vx *= 0.98;
            particle.vy *= 0.98;
            
            // Gentle return to original position
            const returnForce = 0.01;
            particle.vx += (particle.originalX - particle.x) * returnForce;
            particle.vy += (particle.originalY - particle.y) * returnForce;
            
            // Keep particles on screen
            if (particle.x < 0 || particle.x > window.innerWidth) {
              particle.vx *= -0.5;
              particle.x = Math.max(0, Math.min(window.innerWidth, particle.x));
            }
            if (particle.y < 0 || particle.y > window.innerHeight) {
              particle.vy *= -0.5;
              particle.y = Math.max(0, Math.min(window.innerHeight, particle.y));
            }
            
            // Update DOM position
            particle.element.style.left = particle.x + 'px';
            particle.element.style.top = particle.y + 'px';
          });
          
          requestAnimationFrame(() => this.animateParticles());
        }

        testSave() {
          // Test storage functionality
          console.log("=== TESTING STORAGE SYSTEM ===");

          const storageInfo = this.storage.getStorageInfo();
          console.log("Storage info:", storageInfo);

          // Test write/read
          const testData = { test: "data", timestamp: Date.now(), browser: navigator.userAgent };
          this.storage.setItem("test_item", JSON.stringify(testData));
          const retrieved = this.storage.getItem("test_item");

          if (retrieved) {
            console.log("‚úì Can write/read storage");
            const parsed = JSON.parse(retrieved);
            console.log("Test data:", parsed);
            this.storage.removeItem("test_item");
          } else {
            console.log("‚úó Cannot read from storage");
          }

          // Show current stored data
          console.log("Current stored data:");
          console.log("Todos:", this.storage.getItem("homepage_todos"));
          console.log("Bookmarks:", this.storage.getItem("homepage_bookmarks"));
          console.log("Notes:", this.storage.getItem("homepage_notes"));
          console.log("Theme:", this.storage.getItem("homepage_theme"));
          console.log("Card Order:", this.storage.getItem("cardOrder"));

          this.updateDebugInfo();
        }

        clearAll() {
          if (
            confirm(
              "Are you sure you want to clear all data? This cannot be undone.",
            )
          ) {
            this.storage.removeItem("homepage_todos");
            this.storage.removeItem("homepage_bookmarks");
            this.storage.removeItem("homepage_notes");
            this.storage.removeItem("homepage_theme");
            this.storage.removeItem("cardOrder");

            this.todos = [];
            this.bookmarks = [];
            this.notes = [];
            this.cardOrder = [];
            this.isDark = false;
            this.isEditMode = false;
            
            document.body.className = "theme-light";
            const themeToggle = document.getElementById("themeToggle");
            if (themeToggle) themeToggle.textContent = "üåô";
            
            const editToggle = document.getElementById("editModeToggle");
            if (editToggle) {
              editToggle.classList.remove('active');
              editToggle.textContent = '‚úèÔ∏è';
            }

            this.render();
            this.renderCalendar();
            this.updateDebugInfo();

            console.log("All data cleared");
          }
        }

        updateDebugInfo() {
          const debugInfo = document.getElementById("debugInfo");
          if (debugInfo) {
            const storageInfo = this.storage.getStorageInfo();
            debugInfo.innerHTML = `
                        Saved: ${this.todos.length} todos, ${this.bookmarks.length} bookmarks, ${this.notes.length} notes
                        <br>Theme: ${this.isDark ? "dark" : "light"} | Edit Mode: ${this.isEditMode ? "ON" : "OFF"}
                        <br>Storage: ${storageInfo.type} (${storageInfo.available ? "‚úì" : "‚ö†Ô∏è"}) | Items: ${storageInfo.items}
                    `;
          }
        }

        exportData() {
          try {
            const data = this.storage.exportData();
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `homepage-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Data exported successfully! Check your downloads.');
          } catch (e) {
            console.error('Export failed:', e);
            
            // Fallback: show data in a dialog for manual copy
            const data = this.storage.exportData();
            const textarea = document.createElement('textarea');
            textarea.value = data;
            textarea.style.width = '100%';
            textarea.style.height = '200px';
            
            const div = document.createElement('div');
            div.innerHTML = '<p>Copy this data and save it as a .json file:</p>';
            div.appendChild(textarea);
            
            const dialog = document.createElement('div');
            dialog.style.cssText = `
              position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
              background: var(--card-bg); padding: 2rem; border-radius: 16px;
              box-shadow: 0 20px 40px rgba(0,0,0,0.3); z-index: 10000;
              max-width: 80%; max-height: 80%; overflow: auto;
            `;
            dialog.appendChild(div);
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Close';
            closeBtn.className = 'btn btn-small';
            closeBtn.style.marginTop = '1rem';
            closeBtn.onclick = () => document.body.removeChild(dialog);
            dialog.appendChild(closeBtn);
            
            document.body.appendChild(dialog);
            textarea.select();
          }
        }

        importData() {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.json';
          
          input.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const success = this.storage.importData(e.target.result);
                if (success) {
                  // Reload the page data
                  this.loadFromLocalStorage();
                  this.render();
                  this.renderCalendar();
                  this.updateDebugInfo();
                  alert('Data imported successfully!');
                } else {
                  alert('Import failed. Please check the file format.');
                }
              } catch (error) {
                console.error('Import error:', error);
                alert('Import failed: ' + error.message);
              }
            };
            reader.readAsText(file);
          };
          
          input.click();
        }

        render() {
          // Render todos with priority sorting
          const todoList = document.getElementById("todoList");
          if (todoList) {
            // Sort todos by priority (high -> medium -> low) and completion status
            const sortedTodos = this.todos.sort((a, b) => {
              if (a.completed !== b.completed) {
                return a.completed ? 1 : -1; // Completed items go to bottom
              }
              const priorityOrder = { high: 3, medium: 2, low: 1 };
              return (priorityOrder[b.priority] || 2) - (priorityOrder[a.priority] || 2);
            });

            todoList.innerHTML = sortedTodos
              .map((todo) => {
                const status = this.getTodoStatus(todo);
                const priority = todo.priority || 'medium';
                const dueDateText = todo.dueDate
                  ? ` (Due: ${new Date(todo.dueDate).toLocaleDateString()})`
                  : "";

                return `
                                <li class="todo-item ${todo.completed ? "completed" : ""} ${status} priority-${priority}" data-id="${todo.id}">
                                    <input type="checkbox" ${todo.completed ? "checked" : ""}
                                           onchange="homepage.toggleTodo('${todo.id}')">
                                    <span style="flex: 1;">${todo.text}${dueDateText}</span>
                                    <span class="priority-badge">${priority}</span>
                                    <button class="btn btn-small" onclick="homepage.deleteTodo('${todo.id}')"
                                            style="background: var(--danger-gradient); margin-left: 0.5rem;">√ó</button>
                                </li>
                            `;
              })
              .join("");
          }

          // Render bookmarks
          const bookmarksList = document.getElementById("bookmarksList");
          if (bookmarksList) {
            bookmarksList.innerHTML = this.bookmarks
              .map(
                (bookmark) => `
                            <div class="bookmark-item" onclick="window.open('${bookmark.url}', '_blank')">
                                <img class="bookmark-icon" src="${bookmark.icon}" alt=""
                                     onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><text y=%2218%22 font-size=%2220%22>üîó</text></svg>'">
                                <span style="font-size: 0.8rem; text-align: center;">${bookmark.title}</span>
                                <button class="bookmark-delete" onclick="event.stopPropagation(); homepage.deleteBookmark('${bookmark.id}')">√ó</button>
                            </div>
                        `,
              )
              .join("");
          }

          // Render notes
          const notesList = document.getElementById("notesList");
          if (notesList) {
            notesList.innerHTML = this.notes
              .map(
                (note) => `
                            <div class="note-item" ondblclick="homepage.deleteNote('${note.id}')">
                                <div class="note-text">${note.text}</div>
                                <div class="note-date">${new Date(note.createdAt).toLocaleDateString()}</div>
                            </div>
                        `,
              )
              .join("");
          }

          // Update debug info
          this.updateDebugInfo();
        }
      }

      // Enhanced Storage Class for qutebrowser compatibility
      class SafeStorage {
        constructor() {
          this.storageType = 'none';
          this.fallbackStorage = new Map();
          this.init();
        }

        init() {
          // Try different storage methods in order of preference
          this.storageType = this.detectBestStorage();
          console.log(`Using storage type: ${this.storageType}`);
          
          if (this.storageType === 'none') {
            this.showStorageWarning();
          }
        }

        detectBestStorage() {
          // Test localStorage
          if (this.testStorage('localStorage')) {
            return 'localStorage';
          }
          
          // Test sessionStorage as fallback
          if (this.testStorage('sessionStorage')) {
            return 'sessionStorage';
          }
          
          // Try IndexedDB (for future enhancement)
          if (typeof indexedDB !== 'undefined') {
            // Could implement IndexedDB storage here
            console.log('IndexedDB available but not implemented');
          }
          
          // Use in-memory fallback
          return 'memory';
        }

        testStorage(storageType) {
          try {
            const storage = window[storageType];
            if (!storage) return false;
            
            const testKey = '__test_' + Date.now();
            const testValue = 'test_value_' + Math.random();
            
            storage.setItem(testKey, testValue);
            const retrieved = storage.getItem(testKey);
            storage.removeItem(testKey);
            
            return retrieved === testValue;
          } catch (e) {
            console.warn(`${storageType} test failed:`, e.message);
            return false;
          }
        }

        getStorage() {
          switch (this.storageType) {
            case 'localStorage':
              return window.localStorage;
            case 'sessionStorage':
              return window.sessionStorage;
            default:
              return null;
          }
        }

        setItem(key, value) {
          try {
            const storage = this.getStorage();
            if (storage) {
              storage.setItem(key, value);
              console.log(`‚úì Saved to ${this.storageType}: ${key}`);
            } else {
              this.fallbackStorage.set(key, value);
              console.log(`‚úì Saved to memory: ${key}`);
            }
          } catch (e) {
            console.error(`Storage failed for ${key}:`, e);
            this.fallbackStorage.set(key, value);
            this.handleStorageError(e);
          }
        }

        getItem(key) {
          try {
            const storage = this.getStorage();
            if (storage) {
              return storage.getItem(key);
            } else {
              return this.fallbackStorage.get(key) || null;
            }
          } catch (e) {
            console.error(`Retrieval failed for ${key}:`, e);
            return this.fallbackStorage.get(key) || null;
          }
        }

        removeItem(key) {
          try {
            const storage = this.getStorage();
            if (storage) {
              storage.removeItem(key);
            } else {
              this.fallbackStorage.delete(key);
            }
          } catch (e) {
            console.error(`Removal failed for ${key}:`, e);
            this.fallbackStorage.delete(key);
          }
        }

        handleStorageError(error) {
          if (!this.errorShown) {
            this.errorShown = true;
            
            // Try to switch to sessionStorage if localStorage fails
            if (this.storageType === 'localStorage' && this.testStorage('sessionStorage')) {
              this.storageType = 'sessionStorage';
              console.log('Switched to sessionStorage due to localStorage error');
              return;
            }
            
            this.showStorageError(error);
          }
        }

        showStorageWarning() {
          const debugInfo = document.getElementById('debugInfo');
          if (debugInfo) {
            debugInfo.innerHTML += '<br><span style="color: #ffa726;">‚ö†Ô∏è Using temporary storage - data won\'t persist</span>';
          }
        }

        showStorageError(error) {
          const debugInfo = document.getElementById('debugInfo');
          if (debugInfo) {
            debugInfo.innerHTML += `<br><span style="color: #ff6b6b;">‚ùå Storage error: ${error.message}</span>`;
          }
          
          // Show help after a delay
          setTimeout(() => {
            const message = `Storage issue detected in your browser.
            
Current browser: ${navigator.userAgent.includes('qutebrowser') ? 'qutebrowser' : 'Unknown'}

For qutebrowser users:
1. Check your config: :set content.local_storage true
2. Ensure you're not in private mode
3. Try restarting qutebrowser
4. Check storage quota: :set content.persistent_storage ask

For other browsers:
1. Disable private/incognito mode
2. Check site permissions
3. Clear browser cache
4. Try refreshing the page

Would you like to continue with temporary storage?`;

            if (confirm(message)) {
              console.log('User accepted temporary storage');
            }
          }, 3000);
        }

        exportData() {
          // Create exportable data object
          const data = {};
          
          if (this.storageType === 'memory') {
            // Export from memory
            this.fallbackStorage.forEach((value, key) => {
              data[key] = value;
            });
          } else {
            // Export from storage
            const storage = this.getStorage();
            if (storage) {
              for (let i = 0; i < storage.length; i++) {
                const key = storage.key(i);
                if (key && key.startsWith('homepage_')) {
                  data[key] = storage.getItem(key);
                }
              }
            }
          }
          
          return JSON.stringify(data, null, 2);
        }

        importData(jsonData) {
          try {
            const data = JSON.parse(jsonData);
            Object.entries(data).forEach(([key, value]) => {
              this.setItem(key, value);
            });
            return true;
          } catch (e) {
            console.error('Import failed:', e);
            return false;
          }
        }

        getStorageInfo() {
          const storage = this.getStorage();
          return {
            type: this.storageType,
            available: this.storageType !== 'memory',
            persistent: this.storageType === 'localStorage',
            items: storage ? storage.length : this.fallbackStorage.size,
            quota: this.getQuotaInfo()
          };
        }

        getQuotaInfo() {
          try {
            if ('storage' in navigator && 'estimate' in navigator.storage) {
              navigator.storage.estimate().then(estimate => {
                console.log('Storage quota:', estimate);
              });
            }
            return 'checking...';
          } catch (e) {
            return 'unknown';
          }
        }
      }

      // New Feature Classes

      class PomodoroTimer {
        constructor() {
          this.minutes = 25;
          this.seconds = 0;
          this.isRunning = false;
          this.isBreak = false;
          this.interval = null;
        }

        updateDisplay() {
          const displayEl = document.getElementById('pomodoroDisplay');
          const statusEl = document.getElementById('pomodoroStatus');
          if (displayEl) {
            const mins = this.minutes.toString().padStart(2, '0');
            const secs = this.seconds.toString().padStart(2, '0');
            displayEl.textContent = `${mins}:${secs}`;
          }
          if (statusEl) {
            if (this.isRunning) {
              statusEl.textContent = this.isBreak ? 'Break time!' : 'Focus time!';
            } else {
              statusEl.textContent = 'Ready to focus';
            }
          }
        }

        start() {
          if (!this.isRunning) {
            this.isRunning = true;
            this.interval = setInterval(() => {
              if (this.seconds === 0) {
                if (this.minutes === 0) {
                  this.complete();
                  return;
                }
                this.minutes--;
                this.seconds = 59;
              } else {
                this.seconds--;
              }
              this.updateDisplay();
            }, 1000);
            this.updateDisplay();
          }
        }

        pause() {
          this.isRunning = false;
          if (this.interval) {
            clearInterval(this.interval);
            this.interval = null;
          }
          this.updateDisplay();
        }

        reset() {
          this.pause();
          this.minutes = this.isBreak ? 5 : 25;
          this.seconds = 0;
          this.updateDisplay();
        }

        complete() {
          this.pause();
          this.isBreak = !this.isBreak;
          this.minutes = this.isBreak ? 5 : 25;
          this.seconds = 0;
          this.updateDisplay();
          
          // Show notification
          if ('Notification' in window && Notification.permission === 'granted') {
            new Notification(this.isBreak ? 'Time for a break!' : 'Break over! Time to focus!');
          }
        }
      }

      class ThemeCustomizer {
        constructor() {
          this.themes = {
            default: {
              primary: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
              secondary: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
              success: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
              warning: 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)',
              danger: 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)'
            },
            tokyonight: {
              primary: 'linear-gradient(135deg, #7aa2f7 0%, #bb9af7 100%)',
              secondary: 'linear-gradient(135deg, #9ece6a 0%, #7dcfff 100%)',
              success: 'linear-gradient(135deg, #9ece6a 0%, #73daca 100%)',
              warning: 'linear-gradient(135deg, #e0af68 0%, #ff9e64 100%)',
              danger: 'linear-gradient(135deg, #f7768e 0%, #ff757f 100%)'
            },
            rosepine: {
              primary: 'linear-gradient(135deg, #eb6f92 0%, #f6c177 100%)',
              secondary: 'linear-gradient(135deg, #c4a7e7 0%, #9ccfd8 100%)',
              success: 'linear-gradient(135deg, #9ccfd8 0%, #56949f 100%)',
              warning: 'linear-gradient(135deg, #f6c177 0%, #ea9a97 100%)',
              danger: 'linear-gradient(135deg, #eb6f92 0%, #ea9a97 100%)'
            },
            catppuccin: {
              primary: 'linear-gradient(135deg, #cba6f7 0%, #89b4fa 100%)',
              secondary: 'linear-gradient(135deg, #f38ba8 0%, #fab387 100%)',
              success: 'linear-gradient(135deg, #a6e3a1 0%, #94e2d5 100%)',
              warning: 'linear-gradient(135deg, #f9e2af 0%, #fab387 100%)',
              danger: 'linear-gradient(135deg, #f38ba8 0%, #eba0ac 100%)'
            },
            dracula: {
              primary: 'linear-gradient(135deg, #bd93f9 0%, #ff79c6 100%)',
              secondary: 'linear-gradient(135deg, #8be9fd 0%, #50fa7b 100%)',
              success: 'linear-gradient(135deg, #50fa7b 0%, #8be9fd 100%)',
              warning: 'linear-gradient(135deg, #f1fa8c 0%, #ffb86c 100%)',
              danger: 'linear-gradient(135deg, #ff5555 0%, #ff79c6 100%)'
            },
            nord: {
              primary: 'linear-gradient(135deg, #88c0d0 0%, #81a1c1 100%)',
              secondary: 'linear-gradient(135deg, #5e81ac 0%, #b48ead 100%)',
              success: 'linear-gradient(135deg, #a3be8c 0%, #8fbcbb 100%)',
              warning: 'linear-gradient(135deg, #ebcb8b 0%, #d08770 100%)',
              danger: 'linear-gradient(135deg, #bf616a 0%, #d08770 100%)'
            }
          };
        }

        setPreset(themeName) {
          const theme = this.themes[themeName];
          if (theme) {
            this.applyTheme(theme);
          }
        }

        randomize() {
          const randomTheme = {
            primary: this.generateRandomGradient(),
            secondary: this.generateRandomGradient(),
            success: this.generateRandomGradient(),
            warning: this.generateRandomGradient(),
            danger: this.generateRandomGradient()
          };
          this.applyTheme(randomTheme);
        }

        generateRandomGradient() {
          const colors = [
            '#ff9a9e', '#fecfef', '#667eea', '#764ba2', '#4facfe', '#00f2fe',
            '#43e97b', '#38f9d7', '#11998e', '#38ef7d', '#ffecd2', '#fcb69f'
          ];
          const color1 = colors[Math.floor(Math.random() * colors.length)];
          const color2 = colors[Math.floor(Math.random() * colors.length)];
          return `linear-gradient(135deg, ${color1} 0%, ${color2} 100%)`;
        }

        applyTheme(theme) {
          const root = document.documentElement;
          root.style.setProperty('--primary-gradient', theme.primary);
          root.style.setProperty('--secondary-gradient', theme.secondary);
          root.style.setProperty('--success-gradient', theme.success);
          root.style.setProperty('--warning-gradient', theme.warning);
          root.style.setProperty('--danger-gradient', theme.danger);
        }
      }

      class WeatherWidget {
        constructor() {
          this.apiKey = null; // Users can add their own API key
          this.init();
        }

        async init() {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              (position) => this.loadWeather(position.coords.latitude, position.coords.longitude),
              () => this.showError('Location access denied')
            );
          } else {
            this.showError('Geolocation not supported');
          }
        }

        async loadWeather(lat, lon) {
          try {
            // Free weather service (OpenWeatherMap requires API key)
            // For demo purposes, showing mock data
            this.showMockWeather();
          } catch (error) {
            this.showError('Weather data unavailable');
          }
        }

        showMockWeather() {
          const locations = ['New York', 'London', 'Tokyo', 'Paris', 'Sydney'];
          const weather = ['Sunny', 'Cloudy', 'Rainy', 'Partly Cloudy', 'Clear'];
          const temp = Math.floor(Math.random() * 30) + 5;
          
          document.getElementById('weatherLocation').textContent = 
            `üìç ${locations[Math.floor(Math.random() * locations.length)]}`;
          document.getElementById('weatherTemp').textContent = `${temp}¬∞C`;
          document.getElementById('weatherDesc').textContent = 
            weather[Math.floor(Math.random() * weather.length)];
          document.getElementById('weatherDetails').textContent = 
            `Humidity: ${Math.floor(Math.random() * 40) + 40}% ‚Ä¢ Wind: ${Math.floor(Math.random() * 15) + 5} km/h`;
        }

        showError(message) {
          document.getElementById('weatherLocation').textContent = 'üìç Location';
          document.getElementById('weatherTemp').textContent = '--¬∞';
          document.getElementById('weatherDesc').textContent = message;
          document.getElementById('weatherDetails').textContent = '';
        }
      }

      // Initialize the homepage
      const homepage = new EnhancedHomepage();
    </script>
  </body>
</html>
